const Discord = require('discord.js');
const Schema = require("../../database/models/triggers");

module.exports = async (client, interaction, args) => {
    var isActive = interaction.options.getString('isactive');
    if (isActive == null) {
        isActive = true;
    }
    var alias = interaction.options.getString('alias').toLowerCase();
    var type = interaction.options.getString('type');
    var typeString = ["‚úñÔ∏è","R√©pond","R√©pond puis supprime","Supprime","Ajoute une r√©action","R√©pond et ajoute une r√©action"];
    var regex = interaction.options.getString('regex');
    if (regexFlags == null) {
        var regexFlags = interaction.options.getString('regexflags');
    } else {
        var regexFlags = "";
    }
    if (type == 1 || type == 2) {
        var response = interaction.options.getString('response');

        if (response.includes(';;')) {
            var responses = response.split(';;');
        } else {
            var responses = [response];
        }
    } else {
        var response = "Pas utilis√©";
    }
    var responsestype = interaction.options.getString('responsestype');
    if (responsestype == null) {
        responsestype = 1;
    }
    var rTypeString = ["‚úñÔ∏è","En s√©quence","Al√©atoire","La premi√®re"];
    var salon = interaction.options.getChannel('salon');
    if (salon == null) {
        salon = "All";
    }
    var target  = interaction.options.getUser('target');
    if (target == null){
        target = "All";
    }
    var targetMode  = interaction.options.getString('targetmode');
    if (targetMode == null){
        targetMode = true;
    }
    var mention = interaction.options.getString('mention');
    if (mention == null) {
        mention = true;
    }
    var replied = interaction.options.getString('replied');
    if (replied == null) {
        replied = true;
    }
    if (type == 4) {
        var emotes = interaction.options.getString('emotes');
        const parsedEmoji = Discord.parseEmoji(emotes);
        if (!parsedEmoji) return client.errNormal({
            error: `Emoji introuvable dans ce serveur!`,
            type: 'editreply'
        }, interaction)
    } else {
        var emotes = "Pas utilis√©"
    };
    var timeDeletion = interaction.options.getString('timedeletion')
    if (timeDeletion == null) {
        timeDeletion = 1000;
    };
    var previousTriggers = {
        isActive: "‚úñÔ∏è",
        alias: "‚úñÔ∏è",
        type: 0,
        regex: "‚úñÔ∏è",
        regexFlags: "‚úñÔ∏è",
        response: "‚úñÔ∏è",
        mention: "‚úñÔ∏è",
        replied: "‚úñÔ∏è",
        emotes: "‚úñÔ∏è"
      };

    await Schema.findOne({ Guild: interaction.guild.id }, async (err, data) => {
        if (data) {
            const existingTriggerIndex = data.Triggers.findIndex(trigger => trigger.alias === alias);
            /*previousTriggers.isActive = data.Triggers[existingTriggerIndex].isActive;
            previousTriggers.alias = data.Triggers[existingTriggerIndex].alias;
            previousTriggers.type = data.Triggers[existingTriggerIndex].type;
            previousTriggers.regex = data.Triggers[existingTriggerIndex].regex;
            previousTriggers.regexFlags = data.Triggers[existingTriggerIndex].regexFlags;
            previousTriggers.response = data.Triggers[existingTriggerIndex].response;
            previousTriggers.mention = data.Triggers[existingTriggerIndex].mention;
            previousTriggers.replied = data.Triggers[existingTriggerIndex].replied;
            previousTriggers.emotes = data.Triggers[existingTriggerIndex].emotes;*/

            if (existingTriggerIndex >= 0) {
                data.Triggers[existingTriggerIndex] = {
                    isActive: isActive,
                    alias: alias,
                    type: type,
                    regex: regex,
                    regexFlags: regexFlags,
                    response: responses,
                    responsesType : responsestype,
                    target : target,
                    targetMode : targetMode,
                    salon: salon,
                    mention: mention,
                    replied: replied,
                    emotes: type === 4 ? {
                        id: parsedEmoji.id,
                        raw: emotes
                    } : emotes
                };
            } else {
                data.Triggers.push({
                    isActive: isActive,
                    alias: alias,
                    type: type,
                    regex: regex,
                    regexFlags: regexFlags,
                    response: responses,
                    responsesType : responsestype,
                    target : target,
                    targetMode : targetMode,
                    salon: salon,
                    mention: mention,
                    replied: replied,
                    emotes: type === 4 ? {
                        id: parsedEmoji.id,
                        raw: emotes
                    } : emotes
                });
            }
            data.save();
        } else {
            const temp = type === 4 ? {
                id: parsedEmoji.id,
                raw: emotes
            } : emotes;
            new Schema({
                Guild: interaction.guild.id,
                Triggers: [
                    {
                        isActive: isActive,
                        alias: alias,
                        type: type,
                        regex: regex,
                        regexFlags: regexFlags,
                        response: responses,
                        responsesType : responsestype,
                        target : target,
                        targetMode : targetMode,
                        salon: salon,
                        mention: mention,
                        replied: replied,
                        emotes: temp
                    }
                ]
            }).save();
        }
    });
        client.succNormal({
            text: `Le mot est ajout√© √† la liste des trigger!`,
            fields: [
                {
                    "name": `üí¨‚îÜ Trigger`,
                    "value": `‚†Ä\n‚úÖ \`${alias}\`\n‚†Ä`
                },
                {
                  "name": `‚èÆÔ∏è Previous`,
                  "value": `‚†Ä\n
                            ‚á¢ **Alias** : \`${previousTriggers.alias}\`\n
                            ‚á¢ **Type** : \`${typeString[previousTriggers.type]}\`\n
                            ‚á¢ **Regex** : \`${previousTriggers.regex}\`\n
                            ‚á¢ **Flags regex** : \`${previousTriggers.regexFlags}\`\n\n
                            ‚á¢ **R√©ponse** : \n‚†Ä‚†Ä‚†Ä\`${previousTriggers.response}\`\n‚†Ä‚†Ä‚†Ä${previousTriggers[0].response}\n
                            ‚á¢ **R√©ponses** : ${rTypeString[previousTriggers.responsesType]}\n
                            ‚á¢ **Emotes** : \`${previousTriggers.emotes}\` ${previousTriggers[0].emotes}\n\n
                            ‚á¢ **Salon** : ${previousTriggers.salon}\n
                            ‚á¢ **Target** : ${previousTriggers.target}\n
                            ‚á¢ **Mode** : ${previousTriggers.targetMode ? `Uniquement la target` : `Exclure la target`}\n\n
                            ‚á¢ **Additionnels** : \n
                                                    ‚†Ä‚†Ä‚†Ä${previousTriggers.mention ? `‚úÖ` : `üü•`}  Mentionne\n
                                                    ‚†Ä‚†Ä‚†Ä${previousTriggers.replied ? `‚úÖ` : `üü•`} Message suivi`,
                  "inline": true
                },
                {
                  "name": `üÜï Nouveau`,
                  "value": `‚†Ä\n
                            ‚á¢ **Alias** : \`${alias}\`\n
                            ‚á¢ **Type** : \`${typeString[type]}\`\n
                            ‚á¢ **Regex** : \`/${regex}/\`\n
                            ‚á¢ **Flags regex** : \`${regexFlags}\`\n\n
                            ‚á¢ **R√©ponse** : \n‚†Ä‚†Ä‚†Ä\`${response}\`\n‚†Ä‚†Ä‚†Ä${response}\n
                            ‚á¢ **R√©ponses** : ${rTypeString[responsestype]}\n
                            ‚á¢ **Emotes** : \`${emotes}\` ${emotes}\n\n
                            ‚á¢ **Cooldown** : ${cooldown} ms\n
                            ‚á¢ **Salon** : ${salon == "All" ? `Tous les salons` : salon}\n
                            ‚á¢ **Target** : ${target == "All" ? `Tout le monde` : target}\n
                            ‚á¢ **Mode** : ${targetMode ? `Uniquement la target` : `Exclure la target`}\n\n
                            ‚á¢ **Additionnels** : \n
                                                    ‚†Ä‚†Ä‚†Ä${mention ? `‚úÖ` : `üü•`}  Mentionne\n
                                                    ‚†Ä‚†Ä‚†Ä${replied ? `‚úÖ` : `üü•`} Message suivi`,
                  "inline": true
                },
                {
                    "name": `Informations`,
                    "value": `\n
                    ‚†Ä‚†Ä‚†Ä${firedLastAt}\n
                    ‚†Ä‚†Ä‚†ÄD√©clench√©s ${firedTimes} fois`
                }
              ],
            type: 'editreply'
        }, interaction);
    
}
/*const Discord = require('discord.js');

const Schema = require("../../database/models/triggers");

module.exports = async (client, interaction, args) => {
    var isActive = interaction.options.getString('isactive');
    var alias = interaction.options.getString('alias').toLowerCase();
    var type = interaction.options.getString('type');
    var typeString = ["blank","R√©pond","R√©pond puis supprime","Supprime","Ajoute une r√©action"];
    var regex = interaction.options.getString('regex');
    if (regexFlags == null) {
        var regexFlags = interaction.options.getString('regexflags');
    } else {
        var regexFlags = "";
    }
    if (type == 1 || type == 2) {
        var response = interaction.options.getString('response');
    } else {
        var response = "Pas utilis√©";
    }
    var mention = interaction.options.getString('mention');
    var replied = interaction.options.getString('replied');
    if (type == 4) {
        var emotes = interaction.options.getString('emotes');
        const parsedEmoji = Discord.parseEmoji(emotes);
        if (!parsedEmoji) return client.errNormal({
            error: `Emoji introuvable dans ce serveur!`,
            type: 'editreply'
        }, interaction)
    } else {
        var emotes = "Pas utilis√©"
    };

    Schema.findOne({ Guild: interaction.guild.id, 'Triggers.alias': alias  }, async (err, data) => {
        if (data) {
            if (data.Triggers.alias.match(alias)) {
                return new Discord.EmbedBuilder()
                .setDescription("Ce trigger existe d√©j√† et a √©t√© mis √† jour avec les nouveaux param√®tres !")
                .addFields({
                    name: `üí¨‚îÜ Param√®tres pr√©c√©dents`,
                    value: ` `
                },
                {
                    name: `üí¨‚îÜ Alias`,
                    value: `${data.Triggers.alias}`
                },
                {
                    name: `üí¨‚îÜ Type`,
                    value: `${typeString[data.Triggers.type]}`
                },
                {
                    name: `üí¨‚îÜ Regex & flags`,
                    value: `${data.Triggers.regex} ${data.Triggers.regexFlags}`
                },
                {
                    name: `üí¨‚îÜ R√©ponse`,
                    value: `${data.Triggers.response}`
                },
                {
                    name: `üí¨‚îÜ Emotes`,
                    value: `${data.Triggers.emotes}`
                },
                {
                    name: `üí¨‚îÜ Additionnels`,
                    value: `Mentionne : ${data.Triggers.mention}` + `Message suivi : ${data.Triggers.replied}`
                },
                {
                    name: `üí¨‚îÜ Nouveaux param√®tres`,
                    value: ` `
                },
                {
                    name: `üí¨‚îÜ Alias`,
                    value: `${alias}`
                },
                {
                    name: `üí¨‚îÜ Type`,
                    value: `${typeString[type]}`
                },
                {
                    name: `üí¨‚îÜ Regex & flags`,
                    value: `${regex} ${regexFlags}`
                },
                {
                    name: `üí¨‚îÜ R√©ponse`,
                    value: `${response}`
                },
                {
                    name: `üí¨‚îÜ Emotes`,
                    value: `${emotes}`
                },
                {
                    name: `üí¨‚îÜ Additionnels`,
                    value: `Mentionne : ${mention}` + `Message suivi : ${replied}`
                })
                .setAuthor({
                    name: client.user.username,
                    iconURL: client.user.avatarURL({ size: 1024 })
                })
                .setColor(client.config.colors.normal)
                .setFooter({
                    text: client.config.discord.footer,
                    iconURL: client.user.avatarURL({ size: 1024 })
                })
                .setTimestamp();
            }
            if(!data.Triggers[0].alias)
            data.Triggers[0].isActive = isActive;
            data.Triggers[0].alias = alias;
            data.Triggers[0].type = type;
            data.Triggers[0].regex = regex;
            data.Triggers[0].regexFlags = regexFlags;
            data.Triggers[0].response = response;
            data.Triggers[0].mention = mention;
            data.Triggers[0].replied = replied;
            if (type == 4) {
                data.Triggers.emotes = {
                        id: parsedEmoji.id,
                        raw: emoji
                    };
            } else {
                data.Triggers.emotes = emotes;
            }
            data.save();
        }
        else {
            if (type == 4) {
                var temp = {
                    id: parsedEmoji.id,
                    raw: emoji
                }
            } else {
                var temp = emotes;
            }
            new Schema({
                Guild: interaction.guild.id,
                Triggers: {
                    isActive: isActive,
                    alias: alias,
                    type: type,
                    regex: regex,
                    regexFlags: regexFlags,
                    response: response,
                    mention: mention,
                    replied: replied,
                    emotes: temp
                }
            }).save();
        }
    })

    client.succNormal({
        text: `Le mot est ajout√© √† la liste des trigger!`,
        fields: [
            {
                name: `üí¨‚îÜ Trigger`,
                value: `${alias}`
            }
        ],
        type: 'editreply'
    }, interaction);
}
*/
 